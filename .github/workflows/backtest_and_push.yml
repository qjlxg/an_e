name: åŸºé‡‘å›æµ‹ä¸æŠ¥å‘Šæ¨é€ (Fund Backtest and Report Push)

# --- è§¦å‘æ¡ä»¶é…ç½® ---
on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual trigger for backtesting'

  # 2. è‡ªåŠ¨è§¦å‘ï¼šå½“ç‰¹å®šæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'backtester.py' # è„šæœ¬å˜åŠ¨æ—¶è¿è¡Œ
      - '.github/workflows/backtest_and_push.yml' # å·¥ä½œæµå˜åŠ¨æ—¶è¿è¡Œ

# å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¾å®šæ—¶åŒºå’ŒæŠ¥å‘Šæ–‡ä»¶å
env:
  TZ: 'Asia/Shanghai'
  REPORT_FILE_NAME: 'fund_backtest_report.md'
  REPORT_DIR: 'backtest_reports' # æŠ¥å‘Šä¿å­˜çš„ç›®å½•

jobs:
  run_backtest_and_push:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest

    # æ­¥éª¤
    steps:
      - name: â±ï¸ è®¾ç½®æ—¶åŒº (ä¸Šæµ·)
        # GitHub Actions é»˜è®¤æ˜¯ UTCï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ TZ å½±å“ Python è¿è¡Œç¯å¢ƒ
        run: echo "TZ=${{ env.TZ }}" >> $GITHUB_ENV
        
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        # å¿…é¡»æ£€å‡ºä»£ç æ‰èƒ½è®¿é—® backtester.py å’Œ fund_data
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # æ ¹æ®æ‚¨çš„è„šæœ¬å…¼å®¹æ€§é€‰æ‹© Python ç‰ˆæœ¬

      - name: ğŸ“¥ å®‰è£…ä¾èµ– (Install dependencies)
        # æ ¹æ®æ‚¨çš„è„šæœ¬ï¼Œå®ƒä¾èµ– pandas å’Œ numpy
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pytz

      - name: ğŸ“‚ æ£€æŸ¥æ•°æ®ç›®å½• (Check fund_data directory)
        # ç¡®ä¿ fund_data ç›®å½•å­˜åœ¨ï¼Œå¦åˆ™è„šæœ¬ä¼šæŠ¥é”™
        run: |
          if [ ! -d "fund_data" ]; then
            echo "::error:: fund_data ç›®å½•ä¸å­˜åœ¨ï¼è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»ºè¯¥ç›®å½•å¹¶æ”¾å…¥CSVæ–‡ä»¶ã€‚"
            exit 1
          fi
          
      - name: ğŸš€ è¿è¡Œå›æµ‹è„šæœ¬ (Run backtester.py)
        # è¿è¡Œ backtester.pyï¼Œå®ƒå°†åœ¨å½“å‰ç›®å½•ç”Ÿæˆ fund_backtest_report.md
        run: python backtester.py
        
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        # æ¨é€å‰å¿…é¡»é…ç½® Git èº«ä»½
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: ğŸ“ ç§»åŠ¨å’Œæš‚å­˜æŠ¥å‘Šæ–‡ä»¶
        # å°†ç”Ÿæˆçš„æŠ¥å‘Šç§»åŠ¨åˆ°æŒ‡å®šç›®å½•å¹¶å‡†å¤‡æäº¤
        run: |
          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p ${{ env.REPORT_DIR }}
          
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼Œæ–¹ä¾¿å†å²ç‰ˆæœ¬è¿½è¸ª
          TIMESTAMP=$(TZ='${{ env.TZ }}' date +%Y%m%d_%H%M%S)
          TARGET_FILE="${{ env.REPORT_DIR }}/backtest_report_${TIMESTAMP}.md"
          
          # ç§»åŠ¨æŠ¥å‘Šæ–‡ä»¶
          mv ${{ env.REPORT_FILE_NAME }} ${TARGET_FILE}
          
          # æš‚å­˜æ–°æŠ¥å‘Šå’Œæœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶ï¼ˆç”¨äºè¦†ç›–ï¼‰
          git add ${TARGET_FILE}
          
          # æ­¤å¤–ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º "latest.md" çš„æ–‡ä»¶ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹æœ€æ–°ç»“æœ
          cp ${TARGET_FILE} ${{ env.REPORT_DIR }}/latest.md
          git add ${{ env.REPORT_DIR }}/latest.md

      - name: â¬†ï¸ æ¨é€æŠ¥å‘Šåˆ°ä»“åº“ (Push report to repository)
        # å¦‚æœæœ‰å˜åŠ¨ï¼ˆå³ç”Ÿæˆäº†æ–°æŠ¥å‘Šï¼‰ï¼Œåˆ™æäº¤å¹¶æ¨é€åˆ°ä»“åº“
        run: |
          if git diff --cached --exit-code; then
            echo "æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– Auto-generated backtest report: $(TZ='${{ env.TZ }}' date +%Y-%m-%d %H:%M:%S)"
            git push
          fi
