name: åŸºé‡‘å›æµ‹ä¸æŠ¥å‘Šæ¨é€ (Fund Backtest and Report Push)

# --- è§¦å‘æ¡ä»¶é…ç½® ---
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual trigger for backtesting'

  # 2. è‡ªåŠ¨è§¦å‘ï¼šå½“ç‰¹å®šæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  
    paths:
      # è§¦å‘è·¯å¾„æ”¹ä¸ºåŒ¹é…æ‰€æœ‰ backtester è„šæœ¬
      - 'backtester*.py' 
      - '.github/workflows/backtest_and_push.yml'

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai'
  # ***** å…³é”®ä¿®å¤ 1: æŠ¥å‘Šæ–‡ä»¶åæ”¹ä¸º V4 è„šæœ¬çš„è¾“å‡º *****
  REPORT_FILE_NAME: 'fund_backtest_v4_report.md'
  REPORT_DIR: 'backtest_reports'

jobs:
  run_backtest_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: â±ï¸ è®¾ç½®æ—¶åŒº (ä¸Šæµ·)
        run: echo "TZ=${{ env.TZ }}" >> $GITHUB_ENV
        
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¥ å®‰è£…ä¾èµ– (Install dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pytz

      - name: ğŸ“‚ æ£€æŸ¥æ•°æ®ç›®å½• (Check fund_data directory)
        run: |
          if [ ! -d "fund_data" ]; then
            echo "::error:: fund_data ç›®å½•ä¸å­˜åœ¨ï¼è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»ºè¯¥ç›®å½•å¹¶æ”¾å…¥CSVæ–‡ä»¶ã€‚"
            # è¿™é‡Œçš„ exit 1 ä¼šåœ¨æ‰¾ä¸åˆ° fund_data æ—¶ç«‹åˆ»ç»ˆæ­¢å·¥ä½œæµ
            exit 1 
          fi
          
      # ***** å…³é”®ä¿®å¤ 2: è¿è¡Œ V4 è„šæœ¬ *****
      - name: ğŸš€ è¿è¡Œ V4 å›æµ‹è„šæœ¬ (Run backtester_v4.py)
        # è¿è¡Œæœ€æ–°çš„ V4 è„šæœ¬ï¼Œå®ƒä¼šç”Ÿæˆ fund_backtest_v4_report.md
        run: python backtester_v4.py
        
      # ***** æ–°å¢æ­¥éª¤: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼Œé˜²æ­¢ mv æŠ¥é”™ *****
      - name: ğŸ” æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ (é˜²mvæŠ¥é”™)
        id: check_report
        run: |
          if [ -f "${{ env.REPORT_FILE_NAME }}" ]; then
            echo "report_found=true" >> $GITHUB_OUTPUT
            echo "âœ… æŠ¥å‘Šæ–‡ä»¶ ${{ env.REPORT_FILE_NAME }} æˆåŠŸæ‰¾åˆ°ã€‚"
          else
            echo "report_found=false" >> $GITHUB_OUTPUT
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶ ${{ env.REPORT_FILE_NAME }} æœªç”Ÿæˆï¼Œè·³è¿‡æ¨é€ã€‚"
          fi

      # åªæœ‰å½“æŠ¥å‘Šæ–‡ä»¶æ‰¾åˆ°æ—¶ï¼Œæ‰æ‰§è¡Œåç»­çš„ Git æ“ä½œ (ä½¿ç”¨ if æ¡ä»¶)
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: ğŸ“ ç§»åŠ¨å’Œæš‚å­˜æŠ¥å‘Šæ–‡ä»¶
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          mkdir -p ${{ env.REPORT_DIR }}
          
          TIMESTAMP=$(TZ='${{ env.TZ }}' date +%Y%m%d_%H%M%S)
          TARGET_FILE="${{ env.REPORT_DIR }}/backtest_report_${TIMESTAMP}}.md"
          
          # ç§»åŠ¨æŠ¥å‘Šæ–‡ä»¶ (ç°åœ¨æ–‡ä»¶ååº”è¯¥åŒ¹é…äº†)
          mv ${{ env.REPORT_FILE_NAME }} ${TARGET_FILE}
          
          git add ${TARGET_FILE}
          
          cp ${TARGET_FILE} ${{ env.REPORT_DIR }}/latest.md
          git add ${{ env.REPORT_DIR }}/latest.md

      - name: â¬†ï¸ æ¨é€æŠ¥å‘Šåˆ°ä»“åº“ (Push report to repository)
        if: steps.check_report.outputs.report_found == 'true'
        run: |
          if git diff --cached --exit-code; then
            echo "æ²¡æœ‰æ–°çš„æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆï¼Œæ— éœ€æäº¤ã€‚"
          else
            # æäº¤ä¿¡æ¯ä¹Ÿæ”¹ä¸º V4
            git commit -m "ğŸ¤– Auto-generated V4 backtest report: $(TZ='${{ env.TZ }}' date +%Y-%m-%d %H:%M:%S)"
            git push
          fi
