# .github/workflows/scrape_fund_data.yml
name: ğŸ“ˆ Scrape Fund Basic Data and Push CSV

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # 1. å…è®¸é€šè¿‡ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘è¿è¡Œ
  workflow_dispatch:
  
  # 2. å½“ä»¥ä¸‹æ–‡ä»¶æœ‰å˜åŠ¨å¹¶è¢«æ¨é€åˆ° 'main' åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main  # è¯·ç¡®ä¿è¿™é‡Œæ˜¯æ‚¨çš„ä¸»åˆ†æ”¯åç§°
    paths:
      - 'fund_scraper.py' 
      - 'Cç±».txt'         
      - '.github/workflows/scrape_fund_data.yml' 

# ã€å¯é€‰å®šæ—¶ä»»åŠ¡é…ç½®ã€‘
# å¦‚æœéœ€è¦å®šæ—¶è¿è¡Œï¼Œè¯·å–æ¶ˆä¸‹æ–¹ schedule çš„æ³¨é‡Šï¼Œ
# CRON_TZ: Asia/Shanghai ç”¨äºè®¾ç½®ä¸Šæµ·æ—¶åŒºï¼ˆUTC 1:00 AM å¯¹åº”ä¸Šæµ·æ—¶é—´ 9:00 AMï¼‰
#   schedule:
#     - cron: '0 1 * * *'
#       env:
#         CRON_TZ: 'Asia/Shanghai'

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå·¥ä½œæµå†™å…¥æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿå°† CSV æ–‡ä»¶æ¨é€åˆ°ä»“åº“
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ç¡®ä¿è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿ Git æäº¤
          fetch-depth: 0

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–åº“
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£… requests (æŠ“å–), beautifulsoup4 (è§£æ), pandas (æ•°æ®å¤„ç†)
          pip install requests beautifulsoup4 pandas

      # æ­¥éª¤ 4: è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬
      - name: Run fund scraper script
        run: python fund_scraper.py

      # æ­¥éª¤ 5: é…ç½® Git æäº¤ä¿¡æ¯
      - name: Configure Git
        run: |
          # é…ç½® Git ç”¨æˆ·åå’Œé‚®ç®±ï¼Œä½¿ç”¨ GitHub Actions æœºå™¨äººèº«ä»½
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 6: æ£€æŸ¥å¹¶æäº¤/æ¨é€æ›´æ”¹
      - name: Commit and push changes
        id: commit_push
        run: |
          git add fund_data.csv
          
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŠ¨ (å³ fund_data.csv æ˜¯å¦æœ‰å˜åŒ–)
          # git diff --cached --exit-code è¿”å›é0è¡¨ç¤ºæœ‰å˜åŠ¨
          if ! git diff --cached --exit-code; then
            echo "::notice file=fund_data.csv::fund_data.csv æ²¡æœ‰å†…å®¹å˜åŠ¨ï¼Œè·³è¿‡æäº¤å’Œæ¨é€ã€‚"
            echo "push_status=no_change" >> $GITHUB_OUTPUT
          else
            # æäº¤å¹¶æ¨é€åˆ°å½“å‰åˆ†æ”¯
            git commit -m "ğŸ“ˆ Update fund_data.csv (Automated by GitHub Actions)"
            git push
            echo "push_status=success" >> $GITHUB_OUTPUT
          fi
          
      # æ­¥éª¤ 7: æ‰“å°æ¨é€ç»“æœï¼ˆå¯é€‰ï¼‰
      - name: Check push status
        if: steps.commit_push.outputs.push_status == 'success'
        run: echo "ğŸ‰ fund_data.csv å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“ã€‚"
