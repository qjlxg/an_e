name: å‡€å€¼æ•°æ®

on:
  
  schedule:
    - cron: '15 13 * * *'
  
  # é€šè¿‡æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘ï¼Œä¸”ä»…å½“æŒ‡å®šçš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶
  push:
    branches:
      - main
    paths:
      - '.github/workflows/fund_spider.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'

jobs:
  run_spider:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu æ“ä½œç³»ç»Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  (Checkout repository)
      uses: actions/checkout@v4
      with:
        # ç¡®ä¿è·å–å®Œæ•´çš„ Git å†å²è®°å½•
        fetch-depth: 0 

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: è®¾ç½®æ—¶åŒº 
      run: |
        sudo apt-get update
        sudo apt-get install -y tzdata 
        sudo timedatectl set-timezone 'Asia/Shanghai'
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        # å®‰è£… fund_spider.py æ‰€éœ€çš„æ‰€æœ‰åº“
        pip install pandas requests aiohttp beautifulsoup4 tenacity json5 jsbeautifier lxml
        
    - name: è¿è¡ŒåŸºé‡‘çˆ¬è™«è„šæœ¬
      run: |
        echo "å¼€å§‹æ‰§è¡Œ fund_spider.py..."
        # è¿è¡Œçˆ¬è™«è„šæœ¬ï¼ŒæŠ“å–å¹¶æ›´æ–°æ•°æ®
        python fund_spider.py
        
    - name: â­ è§£å†³æ¨é€å†²çªï¼šæ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹ (Git Pull)
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆ`git-auto-commit-action` å®é™…ä¸Šä¼šè‡ªåŠ¨é…ç½®ï¼Œä½†ä¸ºäº†ä¿é™©å¯ä»¥å¢åŠ æ­¤æ­¥éª¤ï¼‰
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        # æ‹‰å–å¹¶åˆå¹¶è¿œç¨‹ main åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹ï¼Œä»¥è§£å†³ 'non-fast-forward' é”™è¯¯
        git pull origin main
        
    - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹ (Commit and Push changes)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°ï¼šæŠ“å–æœ€æ–°çš„åŸºé‡‘å‡€å€¼æ•°æ®"
        # è‡ªåŠ¨æ·»åŠ  fund_data ç›®å½•ä¸‹çš„æ‰€æœ‰ CSV æ–‡ä»¶ï¼Œä»¥åŠ Cç±».txt 
        file_pattern: 'fund_fee_result.csv Cç±».txt'
        commit_options: '--allow-empty'
