name: å‡€å€¼æ•°æ®

on:
  
  schedule:
    - cron: '15 13 * * *'
  
  # é€šè¿‡æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘ï¼Œä¸”ä»…å½“æŒ‡å®šçš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶
  push:
    branches:
      - main
    paths:
      - '.github/workflows/fund_spider.yml'
      - 'fund_spider.py'
      - 'Cç±».txt'

jobs:
  run_spider:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu æ“ä½œç³»ç»Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  (Checkout repository)
      uses: actions/checkout@v4
      with:
        # ç¡®ä¿è·å–å®Œæ•´çš„ Git å†å²è®°å½•
        fetch-depth: 0 

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: è®¾ç½®æ—¶åŒº 
      run: |
        sudo apt-get update
        sudo apt-get install -y tzdata 
        sudo timedatectl set-timezone 'Asia/Shanghai'
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        # å®‰è£… fund_spider.py æ‰€éœ€çš„æ‰€æœ‰åº“
        pip install pandas requests aiohttp beautifulsoup4 tenacity json5 jsbeautifier lxml
        
    - name: è¿è¡ŒåŸºé‡‘çˆ¬è™«è„šæœ¬
      run: |
        echo "å¼€å§‹æ‰§è¡Œ fund_spider.py..."
        # è¿è¡Œçˆ¬è™«è„šæœ¬ï¼ŒæŠ“å–å¹¶æ›´æ–°æ•°æ®
        python fund_spider.py
        
    - name: â­ è§£å†³æ¨é€å†²çªï¼šæš‚å­˜ã€æ‹‰å–ã€æ¢å¤
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ›´æ”¹ï¼ˆçˆ¬è™«è„šæœ¬çš„è¾“å‡ºï¼‰
        if ! git diff-index --quiet HEAD --; then
          echo "å‘ç°æœ¬åœ°æ›´æ”¹ï¼Œæ­£åœ¨æš‚å­˜..."
          # 2. æš‚å­˜æœ¬åœ°æ‰€æœ‰ä¿®æ”¹ (çˆ¬è™«è„šæœ¬çš„æ›´æ”¹)
          git stash
          STASHED=true
        else
          echo "æ— æœ¬åœ°æ›´æ”¹ï¼Œè·³è¿‡æš‚å­˜ã€‚"
          STASHED=false
        fi
        
        # 3. æ‹‰å–å¹¶åˆå¹¶è¿œç¨‹ main åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹
        echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull origin main
        
        # 4. å¦‚æœä¹‹å‰æœ‰æš‚å­˜ï¼Œåˆ™æ¢å¤æš‚å­˜çš„æ›´æ”¹
        if [ "$STASHED" = true ]; then
          echo "æ¢å¤æš‚å­˜çš„æ›´æ”¹..."
          # ä½¿ç”¨ git stash pop æ¢å¤æ›´æ”¹ï¼Œå¹¶å°è¯•åˆå¹¶
          git stash pop || true
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰ fund_data ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä»¥ç¡®ä¿å®ƒä»¬è¢« git-auto-commit-action æ•è·
          # å³ä½¿ git stash pop å¯¼è‡´åˆå¹¶å†²çªï¼ˆé€šå¸¸ä¸ä¼šå‘ç”Ÿåœ¨æ•°æ®æ›´æ–°ä¸Šï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç¡®ä¿ä¸‹ä¸€é˜¶æ®µèƒ½å¤„ç†
          git add fund_data/*.csv || true 
        fi
        
    - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹ (Commit and Push changes)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°ï¼šæŠ“å–æœ€æ–°çš„åŸºé‡‘å‡€å€¼æ•°æ®"
        # è‡ªåŠ¨æ·»åŠ  fund_data ç›®å½•ä¸‹çš„æ‰€æœ‰ CSV æ–‡ä»¶ï¼Œä»¥åŠ Cç±».txt å’Œ fund_fee_result.csv 
        # (ç¡®ä¿ fund_data/*.csv è¢«åŒ…å«è¿›æ¥ï¼Œä»¥å¤„ç†çˆ¬è™«äº§ç”Ÿçš„æ›´æ”¹)
        file_pattern: 'fund_fee_result.csv Cç±».txt fund_data/*.csv'
        commit_options: '--allow-empty'
