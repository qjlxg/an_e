# .github/workflows/fetch_fund_data.yml
name: ğŸ’° Fetch Fund Holding Data and Push to Repo

# è§¦å‘æ¡ä»¶
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (ä¾‹å¦‚: æ¯æ—¥æ›´æ–°)'
        required: false
        default: 'Manual run for data update'
  
  # 2. è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      # è„šæœ¬åç§°å·²æ›´æ–°
      - 'fund_data_collector_final.py' 
      - 'Cç±».txt'
      - '.github/workflows/fetch_fund_data.yml'

# è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç”¨äºåç»­çš„ Git æ“ä½œ
env:
  GIT_COMMITTER_NAME: GitHub Actions Bot
  GIT_COMMITTER_EMAIL: actions-bot@github.com

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        # å¿…é¡»ä½¿ç”¨ fetch-depth: 0 æ‰èƒ½æ‹‰å–æ‰€æœ‰å†å²å¹¶è¿›è¡Œåç»­çš„ commit/push æ“ä½œ
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…æ‰€éœ€çš„åº“ï¼šrequestsç”¨äºç½‘ç»œè¯·æ±‚ï¼Œpandas/lxmlç”¨äºHTMLè¡¨æ ¼è§£æï¼Œbeautifulsoup4ç”¨äºHTMLå¤„ç†
          pip install requests pandas beautifulsoup4 lxml

      - name: âš™ï¸ Run Scraper Script
        id: run_script
        # è¿è¡ŒPythonè„šæœ¬ï¼Œæ–‡ä»¶åå·²æ›´æ–°
        run: python fund_data_collector_final.py
      
      - name: â• Configure Git and Add Files
        # é…ç½® Git å¹¶æ·»åŠ æ–°ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶
        run: |
          git config user.name "${{ env.GIT_COMMITTER_NAME }}"
          git config user.email "${{ env.GIT_COMMITTER_EMAIL }}"
          
          # æ ¹æ®ä¸Šæµ·æ—¶åŒºï¼ˆUTC+8ï¼‰è®¡ç®—é¢„æœŸçš„è¾“å‡ºç›®å½• (YYYYMM)
          # ä½¿ç”¨ date -d '8 hours ago' å°† UTC æ—¶é—´è°ƒæ•´åˆ°æ¥è¿‘ä¸Šæµ·æ—¶é—´
          REPORT_DIR=$(date -u +%Y%m -d '8 hours ago')
          echo "Expected directory: $REPORT_DIR"
          
          # æ·»åŠ æ–°ç”Ÿæˆçš„ç›®å½•å’Œæ–‡ä»¶
          if [ -d "$REPORT_DIR" ]; then
            git add $REPORT_DIR
            echo "Added new directory: $REPORT_DIR"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --cached --quiet; then
            echo "No changes to commit. Exiting step."
            exit 0
          else
            echo "Changes detected. Preparing to commit."
          fi

      - name: ğŸ’¾ Commit and Push Changes
        # æäº¤å¹¶æ¨é€æ–°æ–‡ä»¶åˆ°ä»“åº“
        run: |
          # åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æ‰§è¡Œ commit å’Œ push
          if ! git diff --cached --quiet; then
            COMMIT_MESSAGE="Auto update: Fund holding data for $(date -u +%Y-%m-%d) (Shanghai Time)"
            git commit -m "$COMMIT_MESSAGE"
            echo "Committing with message: $COMMIT_MESSAGE"
            # æ¨é€åˆ°é»˜è®¤åˆ†æ”¯
            git push
            echo "Successfully pushed changes to repository."
          else
            echo "No changes to commit. Skip pushing."
          fi
