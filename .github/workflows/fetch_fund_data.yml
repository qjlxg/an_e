# .github/workflows/data_collection.yml
name: ğŸ’° Fund Data Collector

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
  
  # 2. å½“ fund_data_collector_final.py æˆ–æ­¤å·¥ä½œæµæ–‡ä»¶ (yml) å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'fund_data_collector_final.py'
      - '.github/workflows/data_collection.yml'

jobs:
  collect_data:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        # å…è®¸ actions/checkout è®¿é—®åç»­æ­¥éª¤ä¸­åˆ›å»ºçš„æäº¤ï¼Œå¦åˆ™å¯èƒ½ä¼šå¤±è´¥
        with:
          fetch-depth: 0 

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas

      # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)ï¼Œç­‰åŒäºä¸­å›½æ—¶åŒºï¼ˆä¸œå…«åŒºï¼‰
      - name: â° Set up time zone
        uses: sergeysova/markdown-link-check@v1.7.1 # ä½¿ç”¨ä¸€ä¸ªå¸¸ç”¨çš„action
        with:
          timezone: Asia/Shanghai
          
      # è¿è¡Œ Python è„šæœ¬
      - name: ğŸš€ Run data collection script
        run: python fund_data_collector_final.py

      # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ CSV æ–‡ä»¶ç”Ÿæˆ
      - name: ğŸ•µï¸ Check for new data files
        id: check_files
        # æ£€æŸ¥å½“å‰è¿è¡Œçš„å¹´æœˆç›®å½•ä¸­æ˜¯å¦æœ‰æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶
        # è„šæœ¬ä¸­çš„ç›®å½•ç»“æ„ä¸º $Y/$M/
        run: |
          YEAR=$(date -u +%Y -d '8 hours')
          MONTH=$(date -u +%m -d '8 hours')
          NEW_FILES=$(find ${YEAR}/${MONTH} -name "*.csv" -type f 2>/dev/null | xargs)
          echo "files=$NEW_FILES" >> $GITHUB_OUTPUT
        shell: bash
        
      # æäº¤æ–°çš„ CSV æ–‡ä»¶åˆ°ä»“åº“
      - name: ğŸ’¾ Commit and Push new data
        if: steps.check_files.outputs.files != '' # åªæœ‰å½“æœ‰æ–°æ–‡ä»¶æ—¶æ‰æ‰§è¡Œ
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ£€æŸ¥å¹¶æ·»åŠ æ‰€æœ‰æ–°çš„ CSV æ–‡ä»¶
          git add -N .
          if ! git diff --exit-code --quiet; then
            # æ–‡ä»¶æœ‰å˜åŒ–ï¼Œè¿›è¡Œæ·»åŠ å’Œæäº¤
            git add .
            COMMIT_MESSAGE="ğŸ“ˆ Data update: $(date -u +'%Y-%m-%d %H:%M:%S' -d '8 hours') CST"
            git commit -m "${COMMIT_MESSAGE}"
            git push
            echo "Successfully committed and pushed new data."
          else
            echo "No new changes to commit."
          fi
