name: ğŸ’° info
on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # 2. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # æ›¿æ¢ä¸ºæ‚¨çš„ä¸»åˆ†æ”¯åç§°
    paths:
      - 'fund_script_full_info.py' # æ›´æ”¹ä¸ºæ–°çš„è„šæœ¬æ–‡ä»¶å
      - '.github/workflows/fund_info_worker.yml'

# è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç”¨äºç¡®ä¿åç»­æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³å’Œ git æäº¤æ—¶é—´ä½¿ç”¨ä¸Šæµ·æ—¶åŒº
env:
  TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·

jobs:
  fetch_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ å®‰è£… Requests, Pandas å’Œ BeautifulSoup4 ä¾èµ–
        # çˆ¬è™«éœ€è¦ requests å’Œ bs4ï¼ŒCSV è¾“å‡ºéœ€è¦ pandas
        run: pip install requests pandas beautifulsoup4

      - name: ğŸƒ è¿è¡ŒåŸºé‡‘ä¿¡æ¯å¹¶è¡Œè„šæœ¬
        # è¿è¡Œæ–°çš„è„šæœ¬æ–‡ä»¶
        run: python fund_script_full_info.py
      
      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŠ¨
        id: git-check
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          OUTPUT_FILE="fund_details.csv"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if [ -n "$(git status --porcelain ${OUTPUT_FILE})" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "å‘ç°æ–‡ä»¶å˜åŠ¨ï¼Œå‡†å¤‡æ¨é€ã€‚"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶æ²¡æœ‰å˜åŠ¨ï¼Œè·³è¿‡æ¨é€æ­¥éª¤ã€‚"
          fi

      - name: â¬†ï¸ æ¨é€ç»“æœåˆ°ä»“åº“
        if: steps.git-check.outputs.changes == 'true'
        run: |
          OUTPUT_FILE="fund_details.csv"
          
          # æ·»åŠ ç”Ÿæˆçš„ç»“æœæ–‡ä»¶
          git add ${OUTPUT_FILE}
          
          # æäº¤æ›´æ”¹
          timestamp=$(date "+%Y-%m-%d %H:%M:%S")
          git commit -m "ğŸ¤– Auto update fund info (Full Data/CSV): ${timestamp} (Asia/Shanghai)"
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push
