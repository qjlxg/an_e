name: ğŸš€ å›æµ‹ç­–ç•¥è¿è¡Œ

# --------------------------
# 1. è§¦å‘æ¡ä»¶
# --------------------------
on:
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub Actions é¡µé¢è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:
  
  # å½“ main åˆ†æ”¯ä¸Šçš„ç‰¹å®šæ–‡ä»¶æœ‰å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main # ç¡®ä¿åªåœ¨ä¸»åˆ†æ”¯ä¸Šè¿è¡Œæ—¶è‡ªåŠ¨è§¦å‘
    paths:
      - 'backtester.py' # å½“å›æµ‹è„šæœ¬å˜åŠ¨æ—¶
      - '.github/workflows/backtest.yml' # å½“å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶

# --------------------------
# 2. ç¯å¢ƒå˜é‡ (ç»Ÿä¸€é…ç½®)
# --------------------------
env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai' # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·
  REPORT_BASE_NAME: 'backtest_report' # æŠ¥å‘Šæ–‡ä»¶åŸºç¡€å
  
jobs:
  run_backtest:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          # ç”¨äºæäº¤æ–°æ–‡ä»¶çš„å‡­è¯
          token: ${{ secrets.GITHUB_TOKEN }} 
          
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      # 3. å®‰è£…ä¾èµ– (å‡è®¾éœ€è¦ pandas, numpy ç­‰)
      - name: âš™ï¸ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pytz
          
      # 4. è¿è¡Œå›æµ‹è„šæœ¬ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°ä¸´æ—¶æ–‡ä»¶
      - name: ğŸƒ è¿è¡Œå›æµ‹è„šæœ¬å¹¶ç”ŸæˆæŠ¥å‘Š
        id: run_script
        # è®¾ç½®æ—¶åŒºï¼Œå¹¶è¿è¡Œ backtester.py
        run: |
          # åŠ¨æ€è·å–å½“å‰ä¸Šæµ·æ—¶åŒºæ—¶é—´ï¼Œç”¨äºå‘½åæ–‡ä»¶å’Œç›®å½•
          NOW=$(TZ=${{ env.TZ }} date +'%Y%m%d_%H%M%S')
          DIR_NAME=$(TZ=${{ env.TZ }} date +'%Y%m')
          REPORT_FILENAME="${{ env.REPORT_BASE_NAME }}_${NOW}.txt"
          
          echo "REPORT_DIR=$DIR_NAME" >> $GITHUB_OUTPUT
          echo "REPORT_FILE=$REPORT_FILENAME" >> $GITHUB_OUTPUT
          
          # è¿è¡Œè„šæœ¬ï¼Œå¹¶å°†ç»ˆç«¯è¾“å‡ºé‡å®šå‘åˆ°ä¸´æ—¶æ–‡ä»¶
          python backtester.py > "${REPORT_FILENAME}"
        env:
          # å°† PYTHONIOENCODING è®¾ç½®ä¸º utf-8 ä»¥ç¡®ä¿ä¸­æ–‡è¾“å‡ºæ­£ç¡®
          PYTHONIOENCODING: utf-8

      # 5. åˆ›å»ºç›®æ ‡ç›®å½• (å¹´/æœˆ)
      - name: ğŸ“‚ åˆ›å»ºç›®æ ‡ç›®å½•
        run: |
          mkdir -p ${{ steps.run_script.outputs.REPORT_DIR }}
          mv ${{ steps.run_script.outputs.REPORT_FILE }} ${{ steps.run_script.outputs.REPORT_DIR }}/
          
      # 6. å°†ç»“æœæ¨é€åˆ°ä»“åº“
      - name: â¬†ï¸ æ¨é€å›æµ‹æŠ¥å‘Šåˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æäº¤ä¿®æ”¹åçš„ç›®å½•å’Œæ–‡ä»¶
          commit_message: "ğŸ¤– CI: è‡ªåŠ¨æ›´æ–°å›æµ‹æŠ¥å‘Š ${{ steps.run_script.outputs.REPORT_DIR }}/${{ steps.run_script.outputs.REPORT_FILE }}"
          file_pattern: ${{ steps.run_script.outputs.REPORT_DIR }}/**
          # ç¡®ä¿æäº¤è€…ä¿¡æ¯æ­£ç¡®
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
          commit_author: GitHub Actions Bot <actions@github.com>
          # ä¸ä¸Šä¼ åˆ°å·¥ä»¶ï¼Œç›´æ¥æ¨é€åˆ°ä»“åº“
          skip_dirty_check: true
