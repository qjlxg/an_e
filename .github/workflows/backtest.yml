name: 历史回测

# 触发工作流的条件
on:
  # 1. 允许手动触发 (通过 GitHub Actions 界面)
  workflow_dispatch:

  # 2. 当 backtester.py 或 workflow 文件变动时自动运行
  push:
    branches:
      - main
      - master # 假设您的主分支是 main 或 master
    paths:
      - 'backtester.py'
      - '.github/workflows/backtest.yml'

jobs:
  backtest_and_push:
    runs-on: ubuntu-latest
    
    # 关键设置：启用内容写入权限，允许工作流推送回仓库
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 设置 Python 3.x 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 安装 Python 依赖 (pandas, numpy)
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      # --- 关键步骤 1: 设置时区并运行回测 ---
      - name: 运行历史回测脚本 (基于 Asia/Shanghai 时间)
        run: |
          # 设置 TZ 环境变量，确保所有基于系统时间的命令（包括 Python 内部的 datetime.now()）使用上海时区
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          export TZ='Asia/Shanghai'
          
          # 执行回测脚本
          python backtester.py

      # --- 关键步骤 2: 推送结果到 YYYYMM 目录 ---
      - name: 提交报告到年月目录并推送
        run: |
          # 1. 配置 Git 用户为 github-actions[bot]
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # 2. 获取上海时间 YYYYMM 目录名
          # 使用 TZ='Asia/Shanghai' 确保时间基准正确
          REPORT_DIR=$(TZ='Asia/Shanghai' date +%Y%m)
          
          # 获取生成的报告文件名 (backtester.py 确保只有一个)
          REPORT_FILENAME=$(ls backtest_report_*.md)

          echo "目标目录: ${REPORT_DIR}"
          echo "报告文件: ${REPORT_FILENAME}"

          # 3. 创建目录并移动文件
          mkdir -p ${REPORT_DIR}
          mv ${REPORT_FILENAME} ${REPORT_DIR}/

          # 4. 提交并推送
          # 检查是否有文件变动 (新目录或新报告)
          if [ -n "$(git status --porcelain)" ]; then
            git add ${REPORT_DIR}
            # [skip ci] 避免本次推送再次触发工作流，造成无限循环
            git commit -m "Automated Backtest: Add report ${REPORT_DIR}/${REPORT_FILENAME} [skip ci]"
            git push
          else
            echo "没有新的回测报告或文件变动，跳过推送。"
          fi
