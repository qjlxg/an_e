name: 基金策略历史回测 (Backtest Strategy)

# 触发工作流的条件
on:
  # 1. 每次推送到主分支时执行
  push:
    branches:
      - main
      - master
    paths:
      - 'backtester.py' # 仅当 backtester.py 或 workflow 文件本身变化时触发
      - '.github/workflows/backtest.yml'
  
  # 2. 定时计划任务执行 (例如，每天凌晨 00:00 UTC+8 自动回测)
  # 注意: GitHub Actions 使用 UTC 时间。如果想在 UTC+8 运行，需相应调整。
  schedule:
    # 每天 16:00 UTC (北京时间次日 00:00) 运行
    - cron: '0 16 * * *' 
  
  # 3. 允许手动触发 (通过 GitHub Actions 界面)
  workflow_dispatch:

# 定义环境变量，供所有步骤使用
env:
  PYTHON_VERSION: '3.10'
  FUND_DATA_DIR: fund_data

jobs:
  run_backtest:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 运行环境
    
    steps:
      # 1. 检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: 设置 Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # 3. 安装依赖
      - name: 安装 Python 依赖
        run: |
          # 假设 backtester.py 只需要 pandas 和 numpy
          python -m pip install --upgrade pip
          pip install pandas numpy

      # 4. 准备数据目录 (关键步骤：模拟数据存在)
      # ⚠️ 注意: 这一步需要您自己确保 fund_data 目录和里面的 .csv 文件能被拉取或创建。
      #    如果您的数据位于其他私有仓库或需要专门下载，您需要修改此步骤。
      #    此处仅创建目录并添加一个占位符。
      - name: 准备基金数据目录
        run: |
          mkdir -p ${{ env.FUND_DATA_DIR }}
          # 假设您的数据已存在于此目录，或者您将在此处添加数据下载/解压步骤
          echo "确保您的基金历史数据（例如：001234.csv）已存在于 fund_data 目录中。"

      # 5. 执行回测脚本
      - name: 运行历史回测脚本
        id: backtest_run
        # 假设 backtester.py 在主目录下
        run: python backtester.py
      
      # 6. 上传回测报告 (将生成的 .md 文件作为 Artifact 保存)
      - name: 查找并上传回测报告
        uses: actions/upload-artifact@v4
        with:
          name: backtest-report-${{ github.sha }}
          # backtester.py 的输出文件格式为 backtest_report_YYYYMMDD.md
          path: backtest_report_*.md
          retention-days: 90 # 报告保留 90 天
      
      # 7. (可选) 通知/发布结果
      - name: 发布回测结果到 GitHub Pages (或 Gist/Slack)
        if: always() # 即使上一步失败，也尝试运行通知
        run: |
          echo "回测报告已生成并作为 Artifact 上传。请到 Actions 页面下载报告。"
          # 可以在此添加脚本将报告内容发送到 Slack/微信/邮件等通知系统。
