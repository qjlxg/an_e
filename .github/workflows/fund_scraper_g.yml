name: ğŸ“ˆ Scrape Fund Basic Data and Push CSV

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # è„šæœ¬å’Œæ•°æ®æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'fund_scraper_g.py'
      - 'Cç±».txt'
      - '.github/workflows/fund_scraper_g.yml'
  # æ¯å¤©å®šæ—¶è‡ªåŠ¨è¿è¡Œï¼ˆä¸Šæµ·æ—¶é—´æ—©ä¸Š 8:00ï¼‰
  schedule:
    # cronè¡¨è¾¾å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨
    # 0 0 * * * æ˜¯ UTC 0:00ï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶é—´ 8:00
    - cron: '0 0 * * *'

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    # ç¡®ä¿æœ‰å†™å…¥æƒé™æ¥æäº¤æ–‡ä»¶
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: è®¾ç½®å·¥ä½œæµæ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿ cron è°ƒåº¦å’Œæ—¥å¿—æ—¶é—´æ­£ç¡®
      - name: Set Time Zone to Shanghai
        uses: sergeysova/boilerplate-action@v1.0.0
        with:
          timezone: Asia/Shanghai

      # æ­¥éª¤ 2: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas

      # æ­¥éª¤ 5: è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬
      - name: Run fund scraper script
        # ä½¿ç”¨ -u é€‰é¡¹å¼ºåˆ¶ Python ä¸ç¼“å†²è¾“å‡º
        run: python -u fund_scraper_g.py

      # æ­¥éª¤ 6: é…ç½® Git æäº¤ä¿¡æ¯
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 7: æ£€æŸ¥å¹¶æäº¤/æ¨é€æ›´æ”¹ (å·²ä¿®æ­£é€»è¾‘)
      - name: Commit and push changes (Logic Fixed)
        id: commit_push
        run: |
          # 1. å°†æ–°ç”Ÿæˆçš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
          git add fund_basic_data_c_class.csv
          
          # 2. æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŠ¨ (0:æ— å˜åŠ¨, 1:æœ‰å˜åŠ¨)
          # --quiet ç¡®ä¿ä¸è¾“å‡ºå·®å¼‚å†…å®¹ï¼Œä»…è¿”å›é€€å‡ºç 
          git diff --cached --exit-code --quiet
          GIT_DIFF_STATUS=$?
          
          # 3. åŸºäº $GIT_DIFF_STATUS è¿›è¡Œåˆ¤æ–­ï¼š
          if [ "$GIT_DIFF_STATUS" -eq 0 ]; then
            # é€€å‡ºç  0: æ— å˜åŠ¨ã€‚æ‰§è¡Œè·³è¿‡ã€‚
            echo "::notice file=fund_basic_data_c_class.csv::fund_basic_data_c_class.csv æ²¡æœ‰å†…å®¹å˜åŠ¨ï¼Œè·³è¿‡æäº¤å’Œæ¨é€ã€‚"
            echo "push_status=no_change" >> $GITHUB_OUTPUT
          else
            # é€€å‡ºç  1: æœ‰å˜åŠ¨ã€‚æ‰§è¡Œæäº¤å’Œæ¨é€ã€‚
            git commit -m "ğŸ“ˆ Update fund_basic_data_c_class.csv (Automated by GitHub Actions)"
            git push
            echo "push_status=success" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 8: æ‰“å°æ¨é€ç»“æœï¼ˆå¯é€‰ï¼‰
      - name: Check push status
        if: steps.commit_push.outputs.push_status == 'success'
        run: echo "ğŸ‰ fund_basic_data_c_class.csv å·²æˆåŠŸæ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“ã€‚"
