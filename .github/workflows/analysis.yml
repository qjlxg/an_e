name: ğŸ’° Fund Analysis & Push

# è§¦å‘å™¨é…ç½®
on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # 2. å½“ä»¥ä¸‹æ–‡ä»¶å˜åŠ¨å¹¶æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # æ‚¨çš„ä¸»åˆ†æ”¯åç§°
    paths:
      - 'analyze_funds.py'
      - '.github/workflows/analysis.yml'
      - 'fund_data/*.csv' # ä»»ä½•CSVæ–‡ä»¶å˜åŠ¨ä¹Ÿè§¦å‘

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºä¸ºä¸Šæµ·
env:
  TZ: Asia/Shanghai

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œæµåœ¨è¿è¡Œæ—¶çš„æ—¶åŒº
    steps:
    
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ç¡®ä¿å·¥ä½œæµå¯ä»¥æ¨é€æ›´æ”¹
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
          
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      - name: âš™ï¸ Install Dependencies (Pandas, NumPy)
        run: |
          pip install pandas numpy
          
      # æ­¥éª¤ 4: æ‰§è¡Œåˆ†æè„šæœ¬
      - name: ğŸ“ˆ Run Fund Analysis Script
        run: python analyze_funds.py
        # ä½¿ç”¨ if ç¡®ä¿åªæœ‰è„šæœ¬æˆåŠŸè¿è¡Œæ‰ç»§ç»­ä¸‹ä¸€æ­¥
        id: analysis
        
      # æ­¥éª¤ 5: æäº¤å¹¶æ¨é€ç»“æœåˆ°ä»“åº“
      - name: â¬†ï¸ Commit and Push Results (fund_analysis_summary.csv)
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --exit-code ${{ env.OUTPUT_FILE }}; then
            echo "No changes in ${OUTPUT_FILE}. Skipping commit."
          else
            # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
            git add ${{ env.OUTPUT_FILE }}
            git commit -m "Auto: Update fund analysis summary [skip ci]"
            # æ¨é€åˆ°ä»“åº“
            git push
            echo "Successfully pushed updated analysis summary."
          fi
        env:
          OUTPUT_FILE: fund_analysis_summary.csv
