name: ğŸ’° Fund Analysis & Push

# è§¦å‘å™¨é…ç½®
on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # 2. å½“ä»¥ä¸‹æ–‡ä»¶å˜åŠ¨å¹¶æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # æ‚¨çš„ä¸»åˆ†æ”¯åç§°
    paths:
      - 'analyze_funds.py'
      - '.github/workflows/analysis.yml'
      - 'fund_data/*.csv' # ä»»ä½•CSVæ–‡ä»¶å˜åŠ¨ä¹Ÿè§¦å‘

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºä¸ºä¸Šæµ·
env:
  TZ: Asia/Shanghai

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œæµåœ¨è¿è¡Œæ—¶çš„æ—¶åŒº
    steps:
    
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ç¡®ä¿å·¥ä½œæµå¯ä»¥æ¨é€æ›´æ”¹
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          # 3.14 æ˜¯æœ€æ–°çš„é¢„è§ˆç‰ˆï¼Œæˆ‘ä»¬æ”¹ä¸ºæ›´ç¨³å®šçš„ 3.12 æˆ– 3.11 ç‰ˆæœ¬
          python-version: '3.12' 
          
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ– (æ–°å¢ tabulate åº“)
      - name: âš™ï¸ Install Dependencies (Pandas, NumPy, Tabulate)
        run: |
          pip install pandas numpy tabulate
          
      # æ­¥éª¤ 4: æ‰§è¡Œåˆ†æè„šæœ¬
      - name: ğŸ“ˆ Run Fund Analysis Script
        # è¾“å‡ºæ–‡ä»¶å·²åœ¨ Python è„šæœ¬ä¸­å®šä¹‰ä¸º fund_analysis_summary.csv
        run: python analyze_funds.py
        
      # æ­¥éª¤ 5: æäº¤å¹¶æ¨é€ç»“æœåˆ°ä»“åº“
      - name: â¬†ï¸ Commit and Push Results (fund_analysis_summary.csv)
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          OUTPUT_FILE=fund_analysis_summary.csv
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼ˆä½¿ç”¨ --ignore-submodules=dirty å¿½ç•¥å­æ¨¡å—æ›´æ”¹ï¼‰
          if git diff --stat --exit-code $OUTPUT_FILE; then
            echo "No changes in ${OUTPUT_FILE}. Skipping commit."
          else
            # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
            git add $OUTPUT_FILE
            git commit -m "Auto: Update fund analysis summary [skip ci]"
            # æ¨é€åˆ°ä»“åº“
            git push
            echo "Successfully pushed updated analysis summary."
          fi
