name: åŸºé‡‘å‡€å€¼æ•°æ®è‡ªåŠ¨æŠ“å–

on:
  # æ¯å¤©ä¸–ç•Œåè°ƒæ—¶é—´ (UTC) 13:08 è¿è¡Œä¸€æ¬¡ 
  schedule:
    - cron: '0 0 * * *' 
  # ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æˆ–åœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main

jobs:
  run_spider:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu æ“ä½œç³»ç»Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  (Checkout repository)
      uses: actions/checkout@v4
      with:
        # å¿…é¡»å¼€å¯ fetch-depth: 0 æ‰èƒ½åœ¨åé¢æ­£ç¡®æ¨é€åˆ°ä»“åº“
        fetch-depth: 0

    - name: è®¾ç½®æ—¶åŒº
      run: sudo timedatectl set-timezone 'Asia/Shanghai'

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: å®‰è£… Python ä¾èµ–
      run: |
        # å®‰è£… fund_spider.py æ‰€éœ€çš„æ‰€æœ‰åº“
        pip install pandas requests aiohttp beautifulsoup4 tenacity json5 jsbeautifier lxml
        
    - name: è¿è¡ŒåŸºé‡‘çˆ¬è™«è„šæœ¬
      # è°ƒè¯•æç¤ºï¼šå¦‚æœæ‚¨æƒ³åœ¨ Action ä¸­æŸ¥çœ‹æ›´è¯¦ç»†çš„è¾“å‡ºï¼Œå¯ä»¥è®¾ç½® PYTHONUNBUFFERED=1
      run: |
        echo "å¼€å§‹æ‰§è¡Œ fund_spider.py..."
        # è¿è¡Œçˆ¬è™«è„šæœ¬ï¼ŒæŠ“å–å¹¶æ›´æ–°æ•°æ®
        python fund_spider.py
        
    - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹ (Commit and Push changes)
      # ä½¿ç”¨ Git Auto Commit Action è‡ªåŠ¨å¤„ç†æ–‡ä»¶æäº¤å’Œæ¨é€
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        # æäº¤ä¿¡æ¯
        commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–°ï¼šæŠ“å–æœ€æ–°çš„åŸºé‡‘å‡€å€¼æ•°æ®"
        # è‡ªåŠ¨æ·»åŠ  fund_data ç›®å½•ä¸‹çš„æ‰€æœ‰ CSV æ–‡ä»¶ï¼Œä»¥åŠ Cç±».txt (ä»¥é˜²å®ƒè¢«ä¿®æ”¹æˆ–åˆ›å»º)
        file_pattern: 'fund_data/*.csv Cç±».txt'
        # å…è®¸ç©ºæäº¤ï¼Œå¦‚æœæœ¬æ¬¡è¿è¡Œæ²¡æœ‰æ–°æ•°æ®ä¹Ÿä¼šè®°å½•
        commit_options: '--allow-empty'
        # Git ç”¨æˆ·é…ç½® (å¯é€‰ï¼Œé»˜è®¤ä¼šä½¿ç”¨ GitHub Actions Bot)
        # author_name: 'GitHub Actions Bot' 
        # author_email: 'action@github.com'
