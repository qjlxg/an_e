name: Fund Backtest Decision Workflow

on:
  push:
    paths:
      - 'backtest_module.py'
      - 'sell_decision.py' # å› ä¸º backtest ä¾èµ–å®ƒï¼Œæ‰€ä»¥ push æ—¶ä¹Ÿè¦è§¦å‘
      - 'holdings_config.yaml'
      - '.github/workflows/backtest_workflow.yml'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºéšæ—¶å›æµ‹

jobs:
  run_fund_backtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy tenacity tabulate lxml pyyaml
          # ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬ï¼Œå¹¶å‡è®¾æ‚¨åœ¨ backtest_module.py ä¸­å·²ç»å¯¼å…¥äº† pandas_ta (ä½†ç›®å‰æ˜¯å ä½ç¬¦)
          pip install pandas_ta==0.3.14b || pip install pandas_ta # å…¼å®¹æ€§å°è¯•

      - name: Run Backtest Decision Script
        # è¿è¡Œå›æµ‹è„šæœ¬ï¼Œå®ƒä¼šè¾“å‡º backtest_decision_log.csv
        run: |
          python backtest_module.py || echo "Backtest script failed, check logs for details" >&2
        continue-on-error: true  # è„šæœ¬å¤±è´¥ä¸ä¸­æ­¢

      - name: Rename and Archive Backtest Results ğŸ’¾
        run: |
          TIMESTAMP=$(date -u +'%Y%m%d_%H%M%S')
          ARCHIVE_DIR="backtest_reports"
          NEW_FILE_NAME="backtest_decision_log_${TIMESTAMP}.csv"
          NEW_FILE_PATH="${ARCHIVE_DIR}/${NEW_FILE_NAME}"

          if [ -f backtest_decision_log.csv ]; then
            mkdir -p "$ARCHIVE_DIR"
            mv backtest_decision_log.csv "$NEW_FILE_PATH"
            echo "Successfully archived CSV file as $NEW_FILE_PATH"
            echo "ARCHIVED_FILE_PATH=$NEW_FILE_PATH" >> $GITHUB_ENV
          else
            echo "Backtest results CSV file (backtest_decision_log.csv) not found, skipping rename." >&2
            # å…è®¸æµç¨‹ç»§ç»­ï¼Œå¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºå›æµ‹ç»“æœä¸ºç©ºï¼Œä½†ä¸èƒ½å½“ä½œè‡´å‘½é”™è¯¯
          fi

      - name: Commit and push Backtest changes
        if: success() && env.ARCHIVED_FILE_PATH  # ä»…åœ¨è„šæœ¬æˆåŠŸä¸”æœ‰å½’æ¡£æ–‡ä»¶æ—¶è¿è¡Œ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$ARCHIVED_FILE_PATH" ]; then
            git add "$ARCHIVED_FILE_PATH"
          else
            echo "No backtest results to commit."
            exit 0 # æ­£å¸¸é€€å‡º
          fi
          
          git commit -m "Archive backtest report: ${ARCHIVED_FILE_PATH} [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]" || echo "No new backtest results to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
