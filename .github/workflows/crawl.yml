name: è§„æ¨¡

on:
  # å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # å½“è„šæœ¬ã€é…ç½®æ–‡ä»¶æˆ–åŸºé‡‘ä»£ç åˆ—è¡¨å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'scrape_fund_data.py'
      - '.github/workflows/update_data.yml'
      - 'Cç±».txt'

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
env:
  TZ: Asia/Shanghai

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç  (è·å–å®Œæ•´å†å²ç”¨äºå¢é‡å¯¹æ¯”)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æ£€å‡ºæ‰€æœ‰å†å²æäº¤ï¼Œä»¥ä¾¿è„šæœ¬èƒ½æ‰¾åˆ°å¹¶è¯»å–å†å²æ•°æ®æ–‡ä»¶
          fetch-depth: 0 
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 pandas

      - name: è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬ (å¹¶è¡Œ/å¢é‡)
        # è„šæœ¬å°†ç”Ÿæˆ 'å¹´/æœˆ/æ€»è¡¨_YYYYMMDD_HHMMSS.csv' æ ¼å¼çš„æ–‡ä»¶
        run: python scrape_fund_data.py
        
      - name: æ£€æŸ¥å¹¶æ¨é€æ–°ç”Ÿæˆçš„æ•°æ®åˆ°ä»“åº“
        id: push_data
        run: |
          echo "--- æ–‡ä»¶åˆ—è¡¨ (ls -R) ---"
          ls -R
          echo "--------------------------"
          
          # æŸ¥æ‰¾æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶è·¯å¾„ï¼Œå¹¶å­˜å‚¨ä¸ºå˜é‡ï¼ˆåº”åœ¨ å¹´/æœˆ ç›®å½•ä¸‹ï¼‰
          NEW_FILE_PATH=$(find . -type f -name 'æ€»è¡¨_*.csv' | head -n 1)
          
          if [ -z "$NEW_FILE_PATH" ]; then
            echo "::notice::âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ–°çš„æ€»è¡¨æ–‡ä»¶ (æ€»è¡¨_*.csv)ã€‚"
            exit 0 # æ­£å¸¸é€€å‡ºï¼Œæ²¡æœ‰æ–‡ä»¶éœ€è¦æ¨é€
          fi
          
          echo "::notice::âœ… å‘ç°æ–°çš„æ€»è¡¨æ–‡ä»¶: $NEW_FILE_PATH"

          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # å¼ºåˆ¶æ·»åŠ æ•´ä¸ªå·¥ä½œç›®å½•ï¼Œç¡®ä¿æ–°å¢çš„ å¹´/æœˆ ç›®å½•å’Œ CSV æ–‡ä»¶è¢«è¿½è¸ª
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹éœ€è¦æäº¤ ('??' = æ–°æ–‡ä»¶, 'M' = ä¿®æ”¹æ–‡ä»¶)
          if git status --porcelain | grep -q '??' || git status --porcelain | grep -q 'M'; then
            COMMIT_TIME=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            git commit -m "ğŸ¤– Auto: å¢é‡æ›´æ–°åŸºé‡‘æ•°æ®æ€»è¡¨ - ${COMMIT_TIME} (Shanghai)"
            
            # æ¨é€æäº¤
            git push
          else
            echo "æ²¡æœ‰æ–°çš„æ•°æ®æ–‡ä»¶ç”Ÿæˆæˆ–æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚"
          fi
