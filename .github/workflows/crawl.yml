name: è§„æ¨¡

# è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå› '
        required: false
        default: 'Manual run'

  # 2. å½“è„šæœ¬æˆ–é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾ä½ çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'scrape_fund_data.py'  # è„šæœ¬æ–‡ä»¶
      - 'Cç±».txt'              # åŸºé‡‘ä»£ç è¾“å…¥æ–‡ä»¶
      - '.github/workflows/crawl.yml' # YML è‡ªèº«å˜åŠ¨

# ä»»åŠ¡åˆ—è¡¨
jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼Œå½±å“è„šæœ¬å†…éƒ¨çš„æ—¶é—´å‡½æ•° get_shanghai_time() 
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout Repository)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½® fetch-depth: 0 æ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­è¿›è¡Œå®Œæ•´çš„å†å²æäº¤å’Œæ¨é€
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
          
      - name: âœ¨ å®‰è£…ä¾èµ–åº“
        # è„šæœ¬ä¸­ä½¿ç”¨äº† requests, bs4, pandas
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas
          
      - name: ğŸš€ æ‰§è¡ŒåŸºé‡‘æ•°æ®æŠ“å–è„šæœ¬
        run: |
          python scrape_fund_data.py
          
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: â• æš‚å­˜æ‰€æœ‰å˜åŠ¨æ–‡ä»¶
        id: git_add
        run: |
          # 1. æŸ¥æ‰¾æ‰€æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„ .csv æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ awk æå–è·¯å¾„
          CSV_FILES=$(git status --porcelain | grep '^\(A\|M\)' | grep -E '\d{4}/\d{2}/æ€»è¡¨_.*\.csv$' | awk '{print $2}' | xargs)
          
          # 2. æ£€æŸ¥ Cç±».txt æ˜¯å¦å˜åŠ¨ (åªä¿ç•™è·¯å¾„)
          C_CLASS_FILE_STATUS=$(git status --porcelain | grep '^\(A\|M\)' | grep 'Cç±».txt' | awk '{print $2}')

          # 3. åˆå¹¶æ‰€æœ‰éœ€è¦æš‚å­˜çš„æ–‡ä»¶åˆ—è¡¨
          ALL_FILES_TO_ADD="$CSV_FILES $C_CLASS_FILE_STATUS"
          
          # 4. æ¸…ç†åˆå¹¶åçš„å­—ç¬¦ä¸²ï¼Œå»é™¤å¤šä½™ç©ºæ ¼
          ALL_FILES_TO_ADD=$(echo "$ALL_FILES_TO_ADD" | tr -s ' ' | xargs)

          if [ -n "$ALL_FILES_TO_ADD" ]; then
            echo "å‘ç°å˜åŠ¨æ–‡ä»¶: $ALL_FILES_TO_ADD"
            
            # ä½¿ç”¨ xargs -n 1 ç¡®ä¿æ¯ä¸ªæ–‡ä»¶éƒ½å•ç‹¬æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œè§£å†³æ–‡ä»¶åå¸¦ç©ºæ ¼çš„é—®é¢˜
            echo "$ALL_FILES_TO_ADD" | tr ' ' '\n' | xargs -n 1 git add
            
            echo "files_staged=true" >> $GITHUB_OUTPUT
            echo "staged_files_list=$ALL_FILES_TO_ADD" >> $GITHUB_OUTPUT
          else
            echo "æœªå‘ç°éœ€è¦æäº¤çš„å˜åŠ¨ï¼Œè·³è¿‡æäº¤å’Œæ¨é€ã€‚"
            echo "files_staged=false" >> $GITHUB_OUTPUT
          fi
        shell: bash
        
      - name: âœï¸ æäº¤å˜åŠ¨ (Commit Changes)
        # åªæœ‰åœ¨æˆåŠŸæš‚å­˜æ–‡ä»¶åæ‰æ‰§è¡Œæäº¤
        if: steps.git_add.outputs.files_staged == 'true'
        run: |
          COMMIT_MSG="ğŸ¤– Auto Scrape: Update fund data on $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "Committing files: ${{ steps.git_add.outputs.staged_files_list }}"
          # æ‰§è¡Œæäº¤
          git commit -m "$COMMIT_MSG"
          
      - name: ğŸ“¤ æ¨é€æ–°ç”Ÿæˆçš„æˆ–å˜åŠ¨çš„æ–‡ä»¶åˆ°ä»“åº“ (Push)
        # åªæœ‰åœ¨æˆåŠŸæš‚å­˜æ–‡ä»¶åæ‰æ‰§è¡Œæ¨é€
        if: steps.git_add.outputs.files_staged == 'true'
        run: |
          git push
          echo "âœ… Successfully pushed new data to repository."
