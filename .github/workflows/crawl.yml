name: è§„æ¨¡

on:
  # å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # å½“è„šæœ¬ã€é…ç½®æ–‡ä»¶æˆ–åŸºé‡‘ä»£ç åˆ—è¡¨å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'scrape_fund_data.py'
      - '.github/workflows/crawl.yml'
      - 'Cç±».txt'

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
env:
  TZ: Asia/Shanghai

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    # ğŸŒŸ å…³é”®ä¿®æ”¹ï¼šæ˜ç¡®æˆäºˆ GITHUB_TOKEN å¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ ğŸŒŸ
    permissions:
      contents: write 
      
    steps:
      - name: æ£€å‡ºä»£ç  (è·å–å®Œæ•´å†å²ç”¨äºå¢é‡å¯¹æ¯”)
        # æ­¤æ­¥éª¤ä½¿ç”¨å¸¦æœ‰å†™å…¥æƒé™çš„ GITHUB_TOKEN
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 pandas

      - name: è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬ (å¹¶è¡Œ/å¢é‡)
        run: python scrape_fund_data.py
        
      - name: æ£€æŸ¥å¹¶æ¨é€æ–°ç”Ÿæˆçš„æ•°æ®åˆ°ä»“åº“
        id: push_data
        run: |
          echo "--- æ–‡ä»¶åˆ—è¡¨ (ls -R) ---"
          ls -R
          echo "--------------------------"
          
          # æŸ¥æ‰¾æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶è·¯å¾„ï¼Œå¹¶å­˜å‚¨ä¸ºå˜é‡
          NEW_FILE_PATH=$(find . -type f -name 'æ€»è¡¨_*.csv' | sort -r | head -n 1)
          
          if [ -z "$NEW_FILE_PATH" ]; then
            echo "::notice::âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ–°çš„æ€»è¡¨æ–‡ä»¶ (æ€»è¡¨_*.csv)ã€‚"
            exit 0
          fi
          
          echo "::notice::âœ… å‘ç°æ–°çš„æ€»è¡¨æ–‡ä»¶: $NEW_FILE_PATH"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$NEW_FILE_PATH" ]; then
            echo "::error::âŒ ä¸¥é‡é”™è¯¯ï¼šè·¯å¾„ $NEW_FILE_PATH å·²æ‰¾åˆ°ï¼Œä½†æ–‡ä»¶ä¸å­˜åœ¨äºç£ç›˜ä¸Šï¼"
            exit 1 
          fi

          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶ (ç¡®ä¿å¿½ç•¥ .gitignoreï¼Œå¹¶æ·»åŠ æ–°ç›®å½•)
          git add -f $NEW_FILE_PATH
          git add . # æ•æ‰å…¶ä»–å¯èƒ½å˜åŒ–çš„ tracked æ–‡ä»¶
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹éœ€è¦æäº¤
          if git status --porcelain | grep -q '??' || git status --porcelain | grep -q 'M'; then
            COMMIT_TIME=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            COMMIT_MSG="ğŸ¤– Auto: å¢é‡æ›´æ–°åŸºé‡‘æ•°æ®æ€»è¡¨ - ${COMMIT_TIME} (Shanghai)"
            
            git commit -m "$COMMIT_MSG"
            
            echo "::notice::ğŸš€ æ­£åœ¨æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
            # å†æ¬¡å¼ºè°ƒï¼šè¿™é‡Œæ¨é€ä½¿ç”¨çš„æ˜¯ GITHUB_TOKENï¼Œç°åœ¨å®ƒå…·æœ‰å†™å…¥æƒé™
            git push || { 
              echo "::error::ğŸš¨ Git Push å¤±è´¥ï¼è¯·æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼ˆå¦‚æœå¼€å¯ï¼‰æˆ– Git è¯Šæ–­ä¿¡æ¯ã€‚"
              exit 1 
            }
            echo "::notice::âœ… æ¨é€æˆåŠŸã€‚"
          else
            echo "æ²¡æœ‰æ–°çš„æ•°æ®æ–‡ä»¶ç”Ÿæˆæˆ–æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚"
          fi
