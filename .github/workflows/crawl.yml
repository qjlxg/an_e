name: åŸºé‡‘æ•°æ®æŠ“å–ä¸æ¨é€

# è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå› '
        required: false
        default: 'Manual run'

  # 2. å½“è„šæœ¬æˆ–é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾ä½ çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'scrape_fund_data.py'  # è„šæœ¬æ–‡ä»¶
      - 'Cç±».txt'              # åŸºé‡‘ä»£ç è¾“å…¥æ–‡ä»¶
      - '.github/workflows/crawl.yml' # YML è‡ªèº«å˜åŠ¨

# ä»»åŠ¡åˆ—è¡¨
jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·ï¼Œå½±å“è„šæœ¬å†…éƒ¨çš„æ—¶é—´å‡½æ•° get_shanghai_time() 
    # ä»¥åŠæ•´ä¸ª CI/CD è¿è¡Œæ—¶çš„æ—¶é—´æ„ŸçŸ¥ã€‚
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout Repository)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½® fetch-depth: 0 æ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­è¿›è¡Œå®Œæ•´çš„å†å²æäº¤å’Œæ¨é€
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
          
      - name: âœ¨ å®‰è£…ä¾èµ–åº“
        # è„šæœ¬ä¸­ä½¿ç”¨äº† requests, bs4, pandas
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas
          
      - name: ğŸš€ æ‰§è¡ŒåŸºé‡‘æ•°æ®æŠ“å–è„šæœ¬
        id: run_script
        run: |
          python scrape_fund_data.py
          
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶ç”Ÿæˆæˆ–å˜åŠ¨
        id: git_status
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„ .csv æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯åœ¨ YYYY/MM/ ç›®å½•ä¸‹
          NEW_FILES=$(git status --porcelain | grep '^\(A\|M\)' | grep -E '\d{4}/\d{2}/æ€»è¡¨_.*\.csv$' | xargs)
          if [ -n "$NEW_FILES" ]; then
            echo "::set-output name=files_changed::true"
            echo "::set-output name=new_files::$NEW_FILES"
          else
            echo "::set-output name=files_changed::false"
          fi
          
      - name: â• æš‚å­˜å¹¶æäº¤æŠ“å–ç»“æœ
        if: steps.git_status.outputs.files_changed == 'true'
        run: |
          # æš‚å­˜æ‰€æœ‰æ–°ç”Ÿæˆçš„æˆ–ä¿®æ”¹çš„ .csv æ–‡ä»¶å’Œå†å²æ•°æ®ç›¸å…³çš„å˜åŠ¨
          git add ${{ steps.git_status.outputs.new_files }}
          git add Cç±».txt # ç¡®ä¿è¾“å…¥æ–‡ä»¶å˜åŠ¨ä¹Ÿè¢«æäº¤
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ¤– Auto Scrape: Update fund data on $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "Commiting files: ${{ steps.git_status.outputs.new_files }}"
          git commit -m "$COMMIT_MSG"
          
      - name: ğŸ“¤ æ¨é€æ–°ç”Ÿæˆçš„æˆ–å˜åŠ¨çš„æ–‡ä»¶åˆ°ä»“åº“
        if: steps.git_status.outputs.files_changed == 'true'
        # ä½¿ç”¨ git push æ¨é€ï¼Œä¸éœ€è¦ actions/upload-artifact
        run: |
          git push
          echo "âœ… Successfully pushed new data to repository."
