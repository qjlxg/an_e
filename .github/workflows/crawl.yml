name: 规模

# -------------------------------------------------
# 触发方式
# -------------------------------------------------
on:
  workflow_dispatch:               # 手动触发
  push:
    branches:
      - main                     # 请根据实际主分支改名
    paths:
      - 'scrape_fund_data.py'
      - '.github/workflows/crawl.yml'
      - 'C类.txt'

# -------------------------------------------------
# 全局环境变量（上海时区）
# -------------------------------------------------
env:
  TZ: Asia/Shanghai

# -------------------------------------------------
# 任务定义
# -------------------------------------------------
jobs:
  scrape_and_push:
    runs-on: ubuntu-latest

    # 显式声明 GITHUB_TOKEN 的写权限（即使仓库默认改回只读也不受影响）
    permissions:
      contents: write          # 必须的写权限

    steps:
      # -------------------------------------------------
      # 1. 拉取完整历史（增量对比需要）
      # -------------------------------------------------
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # 完整历史

      # -------------------------------------------------
      # 2. 安装 Python & 依赖
      # -------------------------------------------------
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 安装依赖
        run: pip install requests beautifulsoup4 pandas

      # -------------------------------------------------
      # 3. 运行抓取脚本
      # -------------------------------------------------
      - name: 运行数据抓取脚本
        run: python scrape_fund_data.py

      # -------------------------------------------------
      # 4. 提交 & 推送新生成的 CSV
      # -------------------------------------------------
      - name: 提交并推送新生成的总表
        id: push_data
        run: |
          echo "=== 当前工作目录结构 ==="
          ls -R
          echo "=========================="

          # ---- 新增调试：打印 .gitignore 内容（如果存在） ----
          if [ -f ".gitignore" ]; then
            echo "=== .gitignore 内容 ==="
            cat .gitignore
            echo "========================"
          else
            echo "没有 .gitignore 文件。"
          fi

          # 找出最新的总表文件（格式：总表_YYYYMMDD_HHMMSS.csv）
          NEW_FILE=$(find . -type f -name '总表_*.csv' | sort -r | head -n 1)

          if [[ -z "$NEW_FILE" ]]; then
            echo "::notice::未检测到新生成的总表文件，任务结束。"
            exit 0
          fi

          echo "::notice::发现新文件 → $NEW_FILE"

          # ---- 新增调试：打印文件内容（前几行）确认文件存在 ----
          echo "=== 新文件内容预览（head -n 5） ==="
          head -n 5 "$NEW_FILE" || echo "无法读取文件内容！"
          echo "=================================="

          # 配置 Git（使用 GitHub Actions 自带的 bot）
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ---- 新增调试：git add 前 git status ----
          echo "=== git add 前 git status --porcelain ==="
          git status --porcelain
          echo "========================================="

          # ---- 关键：先 add 目录，再强制 add 文件 ----
          NEW_DIR=$(dirname "$NEW_FILE")
          echo "添加目录: $NEW_DIR"
          git add -v "$NEW_DIR"  # -v 显示添加细节

          echo "强制添加文件: $NEW_FILE"
          git add -f -v "$NEW_FILE"  # -v 显示添加细节

          # ---- 新增调试：git add 后 git status ----
          echo "=== git add 后 git status --porcelain ==="
          git status --porcelain
          echo "========================================="

          # 检查是否有实际变更（?? 新文件、M 修改）
          if git status --porcelain | grep -E '^( \?)|(\sM)'; then
            COMMIT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            COMMIT_MSG="Auto: 增量更新基金数据总表 - ${COMMIT_TIME} (Shanghai)"

            git commit -m "$COMMIT_MSG"
            echo "::notice::正在 push 到 ${GITHUB_REF##*/} ..."
            git push origin HEAD:${GITHUB_REF##*/} || {
              echo "::error::Push 失败，请检查分支保护规则或网络。"
              exit 1
            }
            echo "::notice::Push 成功！文件已保存 → $NEW_FILE"
          else
            echo "没有检测到文件变更，跳过提交。"
            # ---- 新增调试：如果无变更，强制检查文件是否被忽略 ----
            echo "=== 调试：检查文件是否被 Git 忽略 ==="
            git check-ignore -v "$NEW_FILE" || echo "文件未被忽略。"
            echo "====================================="
          fi
