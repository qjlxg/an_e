name: è§„æ¨¡

on:
  # å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # å½“è„šæœ¬ã€é…ç½®æ–‡ä»¶æˆ–åŸºé‡‘ä»£ç åˆ—è¡¨å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'scrape_fund_data.py'
      - '.github/workflows/crawl.yml'
      - 'Cç±».txt'

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
env:
  TZ: Asia/Shanghai

jobs:
  scrape_and_push:
    runs-on: ubuntu-latest
    
    # ğŸŒŸ å…³é”®ä¿®æ”¹ï¼šæ˜ç¡®æˆäºˆ GITHUB_TOKEN å¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ ğŸŒŸ
    permissions:
      contents: write 
      
    steps:
      - name: æ£€å‡ºä»£ç  (è·å–å®Œæ•´å†å²ç”¨äºå¢é‡å¯¹æ¯”)
        # æ­¤æ­¥éª¤ä½¿ç”¨å¸¦æœ‰å†™å…¥æƒé™çš„ GITHUB_TOKEN
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 pandas

      - name: è¿è¡Œæ•°æ®æŠ“å–è„šæœ¬ (å¹¶è¡Œ/å¢é‡)
        run: python scrape_fund_data.py
        
      - name: æ£€æŸ¥å¹¶æ¨é€æ–°ç”Ÿæˆçš„æ•°æ®åˆ°ä»“åº“
        id: push_data
        run: |
          echo "--- å½“å‰ç›®å½•ç»“æ„ (ls -R) ---"
          ls -R
          echo "-------------------------------"
          
          # æŸ¥æ‰¾æœ€æ–°çš„æ€»è¡¨æ–‡ä»¶
          NEW_FILE_PATH=$(find . -type f -name 'æ€»è¡¨_*.csv' | sort -r | head -n 1)
          
          if [ -z "$NEW_FILE_PATH" ]; then
            echo "::notice::è­¦å‘Šï¼šæœªæ‰¾åˆ°æ–°çš„æ€»è¡¨æ–‡ä»¶ (æ€»è¡¨_*.csv)ã€‚"
            exit 0
          fi
          
          echo "::notice::å‘ç°æ–°çš„æ€»è¡¨æ–‡ä»¶: $NEW_FILE_PATH"

          # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$NEW_FILE_PATH" ]; then
            echo "::error::ä¸¥é‡é”™è¯¯ï¼šæ–‡ä»¶è·¯å¾„å­˜åœ¨ä½†æ–‡ä»¶ä¸å¯è¯»ï¼"
            exit 1
          fi

          # é…ç½® Git
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # å…³é”®ä¿®å¤ï¼šå…ˆæ·»åŠ æ•´ä¸ªç›®å½•ï¼ˆæ¨èï¼‰ï¼Œå†å¼ºåˆ¶æ·»åŠ æ–‡ä»¶
          NEW_FILE_DIR=$(dirname "$NEW_FILE_PATH")
          echo "æ­£åœ¨æ·»åŠ ç›®å½•: $NEW_FILE_DIR"
          git add "$NEW_FILE_DIR"

          # å†æ¬¡å¼ºåˆ¶æ·»åŠ æ–‡ä»¶ï¼ˆä¿é™©èµ·è§ï¼‰
          git add -f "$NEW_FILE_PATH"

          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git status --porcelain | grep -q '^??' || git status --porcelain | grep -q '^M'; then
            COMMIT_TIME=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            COMMIT_MSG="Auto: å¢é‡æ›´æ–°åŸºé‡‘æ•°æ®æ€»è¡¨ - ${COMMIT_TIME} (Shanghai)"
            
            git commit -m "$COMMIT_MSG"
            
            echo "::notice::æ­£åœ¨æ¨é€æ›´æ”¹..."
            git push origin HEAD:${{ github.ref_name }} || {
              echo "::error::Git Push å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ†æ”¯ä¿æŠ¤è§„åˆ™ã€‚"
              exit 1
            }
            echo "::notice::æ¨é€æˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜è‡³: $NEW_FILE_PATH"
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
