name: Fund Manager Details Scraper (C-Class)

on:
  # æ¯å¤©å›ºå®šæ—¶é—´è¿è¡Œ (ä¾‹å¦‚ UTC 00:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ JST/CST 08:00 æˆ– 09:00)
  schedule:
    - cron: '0 0 * * *' 
  # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    # è®¾ç½®ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¡ç®—å½“å‰æ—¥æœŸå’Œæ—¶é—´æˆ³
    env:
      TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼Œç”¨äºæ—¥å¿—å’Œå½’æ¡£å‘½å

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 1. è®¾ç½®ç¯å¢ƒå’Œä¾èµ–
      # -----------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # æ¨èä½¿ç”¨ç¨³å®šç‰ˆæœ¬
          
      - name: Install Python dependencies
        run: pip install requests selenium pandas

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install ChromeDriver (Automatically finds correct version)
        uses: nanasess/setup-chromedriver@v2
        
      # -----------------------------------------------------
      # 2. è¿è¡Œ Python çˆ¬è™«
      # -----------------------------------------------------
      # æ³¨æ„ï¼šç”±äº Cç±».txt å·²ç»åœ¨ä»“åº“æ ¹ç›®å½•ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è¿è¡Œçˆ¬è™«è„šæœ¬
      - name: Run Python crawler (crawl.py)
        # ç¡®ä¿ chromedriver è·¯å¾„è®¾ç½®æ­£ç¡®ï¼Œä»¥ä¾› crawl.py ä¸­çš„ Service ä½¿ç”¨
        run: PATH=$PATH:/usr/local/bin python crawl.py

      # -----------------------------------------------------
      # 3. è·å–æ—¥æœŸå’Œæ—¶é—´æˆ³ï¼Œç”¨äºå½’æ¡£
      # -----------------------------------------------------
      - name: Get current date and time
        id: date
        run: |
          echo "TIMESTAMP=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
          echo "YEAR=$(date +'%Y')" >> $GITHUB_OUTPUT
          echo "MONTH=$(date +'%m')" >> $GITHUB_OUTPUT
          
      # -----------------------------------------------------
      # 4. æäº¤å’Œæ¨é€æ•°æ®
      # -----------------------------------------------------
      - name: Commit and push fund_manager_details.csv ğŸ’¾
        uses: actions-js/push@v1.4
        with:
          # files: å§‹ç»ˆæäº¤æœ€æ–°çš„ CSV æ–‡ä»¶
          files: 'data/fund_manager_details.csv' 
          # target-branch: ç›®æ ‡åˆ†æ”¯
          target-branch: 'main'
          # message: æäº¤ä¿¡æ¯
          message: "Data Crawl: Fund Manager details (C-Class) [${{ steps.date.outputs.YEAR }}-${{ steps.date.outputs.MONTH }}]"
          # destination: å°†æ–‡ä»¶å½’æ¡£åˆ°æŒ‰å¹´/æœˆ/æ—¶é—´æˆ³å‘½åçš„ç›®å½•ä¸­
          destination: "data_archive/${{ steps.date.outputs.YEAR }}/${{ steps.date.outputs.MONTH }}/fund_manager_details_${{ steps.date.outputs.TIMESTAMP }}.csv"
          # ç¡®ä¿èƒ½å¤Ÿæ¨é€åˆ°ä»“åº“
          github_token: ${{ secrets.GITHUB_TOKEN }}
